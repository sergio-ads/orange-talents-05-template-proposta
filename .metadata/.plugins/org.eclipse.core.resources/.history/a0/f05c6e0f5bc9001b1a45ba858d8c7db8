package br.com.zupacademy.proposta.scheduler;

import java.util.Set;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Configuration;
import org.springframework.scheduling.annotation.EnableAsync;
import org.springframework.scheduling.annotation.EnableScheduling;
import org.springframework.scheduling.annotation.Scheduled;

import br.com.zupacademy.proposta.consumer.CartaoClient;
import br.com.zupacademy.proposta.consumer.response.CartaoResponse;
import br.com.zupacademy.proposta.model.Cartao;
import br.com.zupacademy.proposta.model.Proposta;
import br.com.zupacademy.proposta.repository.CartaoRepository;
import br.com.zupacademy.proposta.repository.PropostaRepository;
import feign.FeignException;

@Configuration
@EnableAsync
@EnableScheduling
public class CartaoScheduler {
    @Autowired
    private PropostaRepository propostaRepository;	
    @Autowired
    private CartaoRepository cartaoRepository;
    @Autowired
    private CartaoClient cartaoClient;
	
	@Scheduled(fixedDelay=10000)
	public void buscarCartoes() {
		
		Set<Proposta> propostas = propostaRepository.findByCartao(null);
		for (Proposta proposta : propostas) {
			System.out.println(proposta);
			try {
				CartaoResponse cartaoResponse = cartaoClient.getCartao(proposta.getId());
				Cartao cartao = cartaoResponse.toModel();
				cartaoRepository.save(cartao)
//				cartaoResponse
			} catch (FeignException e) { }
		}
		
	}

}
